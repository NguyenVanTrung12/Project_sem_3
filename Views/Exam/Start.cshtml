@model IEnumerable<Project_sem_3.Models.Question>

@{
    Layout = "_Layout"; // or "_CustomerLayout"
    ViewData["Title"] = "Aptitude Test";
}

<div id="candidate-test" class="page">
    <div class="container">
        <!-- HEADER -->
        <div class="test-header d-flex justify-content-between align-items-center mb-4">
            <div class="test-info">
                <h2>Aptitude Test - @Model.FirstOrDefault()?.Subject?.SubjectName</h2>
                <p>@Model.Count() questions • 60 minutes • Max score: @Model.Count()</p>
            </div>
            <div class="timer text-center">
                <div class="timer-label">Time Remaining</div>
                <div id="timer" class="timer-display fw-bold text-danger fs-4">60:00</div>
            </div>
        </div>

        <!-- FORM -->
        <form asp-action="Submit" method="post" id="examForm">
            <input type="hidden" name="resultId" value="@ViewBag.ResultId" />
            <input type="hidden" name="candidateId" value="@ViewBag.CandidateId" />
            <input type="hidden" name="typeId" value="@ViewBag.TypeId" />
            <input type="hidden" name="sessionKey" value="Exam_@(ViewBag.CandidateId)_@(Model.First().SubjectId)_@(ViewBag.TypeId)" />

            <div style="display: grid; grid-template-columns: 1fr 300px; gap: 20px;">
                <!-- LEFT: QUESTION AREA -->
                <div id="question-area">
                    @{
                        int index = 1;
                        foreach (var q in Model)
                        {
                            <div class="question-card mb-4" id="question-@index" style="display:@(index == 1 ? "block" : "none")">
                                <div class="question-header d-flex justify-content-between mb-2">
                                    <div class="question-number fw-bold">Question @index/@Model.Count()</div>
                                    <div style="color: #666; font-size: 14px">@q.Mark point(s)</div>
                                </div>

                                <div class="question-text mb-3">@Html.Raw(q.QuestionContent)</div>

                                <div class="options">
                                    @if (q.Answers != null && q.Answers.Any())
                                    {
                                        foreach (var a in q.Answers)
                                        {
                                            <label class="option d-block mb-2">
                                                <input type="radio" name="selectedAnswers[@q.Id]" value="@a.Id" />
                                                <span>@Html.Raw(a.AnswerContent)</span>
                                            </label>
                                        }
                                    }
                                    else
                                    {
                                        <p class="text-danger">No answers available for this question.</p>
                                    }
                                </div>
                            </div>
                            index++;
                        }
                    }

                    <!-- BUTTONS -->
                    <div class="d-flex justify-content-between mt-4">
                        <button type="button" class="btn btn-outline" id="prevBtn">⬅️ Previous</button>
                        <button type="button" class="btn btn-primary" id="nextBtn">Next ➡️</button>
                    </div>
                </div>

                <!-- RIGHT: NAVIGATION -->
                <div class="question-nav">
                    <h3 style="font-size: 16px; margin-bottom: 15px; color: #333;">Question List</h3>
                    <div class="question-grid d-grid" style="grid-template-columns: repeat(5, 1fr); gap: 5px;">
                        @{
                            int num = 1;
                            foreach (var q in Model)
                            {
                                <button type="button" class="question-btn btn btn-outline-secondary" data-index="@num">@num</button>
                                num++;
                            }
                        }
                    </div>

                    <div id="answered-summary" style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; font-size: 13px; color: #856404;">
                        <strong>Note:</strong> You have answered <span id="answeredCount">0</span> out of @Model.Count() questions
                    </div>

                    <button type="submit" class="btn btn-success w-100 mt-3" id="submitBtn">Submit Test</button>
                </div>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // 🕐 60 minutes = 3600 seconds
            const examDuration = 15 * 60;
            const timerDisplay = document.getElementById("timer");
            const storageKey = "examTimer";
            const examForm = document.getElementById("examForm");

            let startTime = localStorage.getItem(storageKey);
            const now = Math.floor(Date.now() / 1000);
            if (!startTime) {
                startTime = now;
                localStorage.setItem(storageKey, startTime);
            } else {
                startTime = parseInt(startTime);
            }

            let timeLeft = examDuration - (now - startTime);

            const updateTimer = () => {
                const min = Math.floor(timeLeft / 60);
                const sec = timeLeft % 60;
                timerDisplay.textContent = `${min}:${sec.toString().padStart(2, "0")}`;
            };

            updateTimer();

            const timer = setInterval(() => {
                timeLeft--;
                updateTimer();

                if (timeLeft <= 0) {
                    clearInterval(timer);
                    alert("⏰ Time’s up! The system will automatically submit your test.");
                    localStorage.removeItem(storageKey);
                    examForm.submit();
                }
            }, 1000);

            examForm.addEventListener("submit", () => {
                localStorage.removeItem(storageKey);
            });
        });

        // 🎯 QUESTION NAVIGATION
        document.addEventListener("DOMContentLoaded", function () {
            let currentIndex = 1;
            const totalQuestions = @Model.Count();

            const prevBtn = document.getElementById("prevBtn");
            const nextBtn = document.getElementById("nextBtn");

            const showQuestion = (index) => {
                // Ẩn/hiện câu hỏi
                for (let i = 1; i <= totalQuestions; i++) {
                    const qCard = document.getElementById("question-" + i);
                    if (qCard) qCard.style.display = (i === index) ? "block" : "none";
                }

                // Cập nhật nút đang chọn trong danh sách bên phải
                document.querySelectorAll(".question-btn").forEach(btn => {
                    btn.classList.remove("btn-primary");
                });
                const currentBtn = document.querySelector(`.question-btn[data-index='${index}']`);
                if (currentBtn) currentBtn.classList.add("btn-primary");

                if (index === 1) {
                    prevBtn.style.display = "none";
                    nextBtn.style.display = "inline-block";
                    nextBtn.style.marginLeft = "auto"; // đẩy sang phải
                } else if (index === totalQuestions) {
                    prevBtn.style.display = "inline-block";
                    nextBtn.style.display = "none";
                    prevBtn.style.marginRight = "auto"; // đẩy sang trái
                } else {
                    prevBtn.style.display = "inline-block";
                    nextBtn.style.display = "inline-block";
                    prevBtn.style.marginRight = "0";
                    nextBtn.style.marginLeft = "0";
                }

            };

            // Sự kiện click nút Previous
            prevBtn.addEventListener("click", () => {
                if (currentIndex > 1) {
                    currentIndex--;
                    showQuestion(currentIndex);
                }
            });

            // Sự kiện click nút Next
            nextBtn.addEventListener("click", () => {
                if (currentIndex < totalQuestions) {
                    currentIndex++;
                    showQuestion(currentIndex);
                }
            });

            // Khi bấm số câu hỏi bên phải
            document.querySelectorAll(".question-btn").forEach(btn => {
                btn.addEventListener("click", () => {
                    const idx = parseInt(btn.getAttribute("data-index"));
                    if (!isNaN(idx)) {
                        currentIndex = idx;
                        showQuestion(currentIndex);
                    }
                });
            });

            // Khởi tạo giao diện ban đầu
            showQuestion(currentIndex);
        });



        // ✅ MARK ANSWERED QUESTIONS
        document.addEventListener("DOMContentLoaded", function () {
            const answeredSet = new Set();
            const answeredCount = document.getElementById("answeredCount");

            document.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.addEventListener("change", () => {
                    const qName = radio.name;
                    answeredSet.add(qName);
                    const qId = qName.match(/\[(\d+)\]/)[1];
                    document.querySelector(`.question-btn[data-index="${qId}"]`)?.classList.add("btn-success");
                    answeredCount.textContent = answeredSet.size;
                });
            });
        });

        // ✅ SAVE, RESTORE, AND COUNT ANSWERS
        document.addEventListener("DOMContentLoaded", function () {
            const storageKey = "examAnswers";
            let answers = JSON.parse(localStorage.getItem(storageKey)) || {};
            const answeredSet = new Set(Object.keys(answers));
            const answeredCount = document.getElementById("answeredCount");

            // When user selects an answer
            document.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.addEventListener("change", () => {
                    const qName = radio.name;
                    answers[qName] = radio.value;
                    localStorage.setItem(storageKey, JSON.stringify(answers));

                    answeredSet.add(qName);
                    answeredCount.textContent = answeredSet.size;

                    // Highlight the answered question
                    const qId = qName.match(/\[(\d+)\]/)[1];
                    const btn = document.querySelector(`.question-btn[data-index="${qId}"]`);
                    if (btn) btn.classList.add("btn-success");
                });
            });

            // Restore saved answers
            for (const [key, value] of Object.entries(answers)) {
                const radio = document.querySelector(`input[name="${key}"][value="${value}"]`);
                if (radio) {
                    radio.checked = true;

                    const qId = key.match(/\[(\d+)\]/)[1];
                    const btn = document.querySelector(`.question-btn[data-index="${qId}"]`);
                    if (btn) btn.classList.add("btn-success");
                }
            }

            // Update answered count on load
            answeredCount.textContent = answeredSet.size;

            // Clear saved data when submitting
            const examForm = document.getElementById("examForm");
            examForm.addEventListener("submit", () => {
                localStorage.removeItem(storageKey);
            });
        });

        // ⚠️ CONFIRM BEFORE SUBMITTING
        document.addEventListener("DOMContentLoaded", function () {
            const submitBtn = document.getElementById("submitBtn");
            submitBtn.addEventListener("click", function (e) {
                const confirmSubmit = confirm("Are you sure you want to submit? Once submitted, you cannot retake the test.");
                if (!confirmSubmit) {
                    e.preventDefault();
                }
            });
        });
    </script>
}

<style>
    .question-btn.btn-primary {
        background-color: #007bff !important;
        color: white !important;
        border-color: #007bff !important;
    }

    #prevBtn {
        display: none;
    }

    .question-card {
        background: #fff;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
    }

    .question-grid .question-btn {
        border-radius: 6px;
        font-weight: 500;
        padding: 8px 0;
    }

    .question-btn.btn-success {
        background-color: #28a745 !important;
        color: #fff !important;
    }

    .btn-outline {
        border: 1px solid #ccc;
    }
</style>
